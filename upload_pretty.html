<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AS 업로드 · Pretty</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-indigo-600 text-white grid place-content-center font-bold">AL</div>
        <h1 class="text-lg font-semibold">AS Upload</h1>
      </div>
      <nav class="flex items-center gap-3">
        <a href="dashboard_pretty.html" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">대시보드</a>
        <a href="upload_pretty.html" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">업로드</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pt-6 pb-20">
    <section class="bg-white rounded-2xl border border-slate-200 p-6 shadow">
      <h2 class="text-xl font-semibold">1) CSV 업로드</h2>
      <p class="mt-1 text-sm text-slate-500">헤더 예시: <code>date_no,customer_name,model,status,cost,branch,created_at</code></p>
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <input id="csvFile" type="file" accept=".csv" class="file:mr-4 file:rounded-lg file:border-0 file:bg-indigo-600 file:px-4 file:py-2 file:text-white rounded-lg border border-slate-300 px-3 py-2">
        <button id="btnUpload" class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-700">업로드</button>
        <button id="btnTemplate" class="px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">샘플 CSV</button>
      </div>
      <div class="mt-4 text-sm text-slate-600">중복 방지: <code>date_no + customer_name + model</code> 기준 <b>upsert</b></div>
    </section>

    <section class="mt-6 bg-white rounded-2xl border border-slate-200 p-6 shadow">
      <h2 class="text-xl font-semibold">2) 단건 입력</h2>
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input id="f_date_no" class="px-3 py-2 rounded-lg border border-slate-300" placeholder="date_no (예: 20251017-001)">
        <input id="f_customer_name" class="px-3 py-2 rounded-lg border border-slate-300" placeholder="customer_name">
        <input id="f_model" class="px-3 py-2 rounded-lg border border-slate-300" placeholder="model">
        <input id="f_status" class="px-3 py-2 rounded-lg border border-slate-300" placeholder="status (complete/pending)">
        <input id="f_cost" class="px-3 py-2 rounded-lg border border-slate-300" placeholder="cost (숫자)">
        <input id="f_branch" class="px-3 py-2 rounded-lg border border-slate-300" placeholder="branch (선택)">
      </div>
      <button id="btnInsertOne" class="mt-4 px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">단건 Upsert</button>
    </section>

    <section class="mt-6 bg-white rounded-2xl border border-slate-200 p-6 shadow">
      <h2 class="text-xl font-semibold">로그</h2>
      <div id="log" class="mt-2 text-sm bg-slate-50 border border-slate-200 rounded-xl p-3 h-48 overflow-auto"></div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
    <div class="bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg text-sm">처리됨</div>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const logBox = document.getElementById('log');
    const toast = (m)=>{const t=document.getElementById('toast');t.firstElementChild.textContent=m;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),1500)};
    const log = (m, cls='')=>{const p=document.createElement('div'); if(cls) p.className=cls; p.textContent=m; logBox.appendChild(p); logBox.scrollTop=logBox.scrollHeight;};

    function parseCSV(text){
      const lines = text.trim().split(/\\r?\\n/);
      const headers = lines[0].split(',').map(h=>h.trim());
      const rows=[];
      for(let i=1;i<lines.length;i++){
        if(!lines[i].trim()) continue;
        const cols = lines[i].split(',').map(c=>c.trim());
        const obj={}; headers.forEach((h,idx)=>obj[h]=cols[idx]??null);
        rows.push(obj);
      }
      return { headers, rows };
    }

    document.getElementById('btnTemplate').addEventListener('click', ()=>{
      const sample = 'date_no,customer_name,model,status,cost,branch,created_at\\n20251017-001,홍길동,LED T2,complete,15000,Seoul,2025-10-17 09:00:00\\n20251017-002,김아카라,Track V1,pending,0,Busan,2025-10-17 10:30:00\\n';
      const blob = new Blob([sample], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'as_upload_sample.csv';
      a.click();
    });

    document.getElementById('btnUpload').addEventListener('click', async ()=>{
      const file = document.getElementById('csvFile').files[0];
      if(!file){ alert('CSV 파일을 선택하세요'); return; }
      const text = await file.text();
      const { headers, rows } = parseCSV(text);
      if(!headers.includes('date_no') || !headers.includes('customer_name') || !headers.includes('model')){
        alert('필수 헤더(date_no, customer_name, model)가 없습니다.'); return;
      }
      rows.forEach(r=>{
        if(r.cost!==undefined && r.cost!==null && r.cost!==''){
          const n = Number(String(r.cost).replace(/[^\\d.-]/g,'')); r.cost = isNaN(n)? null : n;
        }
      });
      log(`총 ${rows.length}건 업로드 시작…`);
      const chunkSize=200;
      for(let i=0;i<rows.length;i+=chunkSize){
        const chunk = rows.slice(i,i+chunkSize);
        const { error } = await supabase.from('as_records').upsert(chunk, { onConflict: ['date_no','customer_name','model'] });
        if(error){ log('에러: '+error.message, 'text-rose-700'); toast('업로드 실패'); return; }
        log(`처리: ${Math.min(i+chunk.length, rows.length)} / ${rows.length}`, 'text-emerald-700');
      }
      toast('업로드 완료');
    });

    document.getElementById('btnInsertOne').addEventListener('click', async ()=>{
      const row = {
        date_no: document.getElementById('f_date_no').value || null,
        customer_name: document.getElementById('f_customer_name').value || null,
        model: document.getElementById('f_model').value || null,
        status: document.getElementById('f_status').value || null,
        cost: Number(document.getElementById('f_cost').value || 0),
        branch: document.getElementById('f_branch').value || null,
      };
      if(!row.date_no || !row.customer_name || !row.model){
        alert('date_no / customer_name / model 필수'); return;
      }
      const { error } = await supabase.from('as_records').upsert([row], { onConflict: ['date_no','customer_name','model'] });
      if(error){ log('에러: '+error.message, 'text-rose-700'); toast('실패'); }
      else{ log('단건 업서트 성공: '+row.date_no, 'text-emerald-700'); toast('완료'); }
    });
  </script>
</body>
</html>
