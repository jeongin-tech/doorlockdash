<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>AS 업로드</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:960px;margin:24px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    .log{white-space:pre-wrap;background:#f8f9fa;border:1px solid #eee;padding:12px;border-radius:8px;max-height:280px;overflow:auto}
    input,button{font-size:16px}
    .ok{color:#0a7f2e}.err{color:#b00020}
  </style>
</head>
<body>
  <header>
    <h1>AS 데이터 업로드</h1>
    <nav><a href="dashboard_gh.html">대시보드</a></nav>
  </header>

  <div class="card">
    <h3>1) CSV 파일 업로드</h3>
    <p><b>CSV 헤더 예시</b>: <code>date_no,customer_name,model,status,cost,branch,created_at</code></p>
    <input id="csvFile" type="file" accept=".csv">
    <button id="btnUpload">업로드</button>
    <p>※ 아주 단순 파서입니다. 값 안에 콤마(,)가 들어가는 CSV는 지원하지 않습니다.</p>
  </div>

  <div class="card">
    <h3>2) 단건 입력 (테스트용)</h3>
    <div style="display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))">
      <input id="f_date_no" placeholder="date_no (예: 20251017-001)">
      <input id="f_customer_name" placeholder="customer_name">
      <input id="f_model" placeholder="model">
      <input id="f_status" placeholder="status (예: complete/pending)">
      <input id="f_cost" placeholder="cost (숫자)">
      <input id="f_branch" placeholder="branch (선택)">
    </div>
    <button id="btnInsertOne">단건 Insert/Upsert</button>
  </div>

  <div class="card">
    <h3>로그</h3>
    <div id="log" class="log"></div>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const logBox = document.getElementById('log');
    const log = (msg, cls='')=>{
      const p=document.createElement('div');
      if(cls) p.className=cls;
      p.textContent = msg;
      logBox.appendChild(p);
      logBox.scrollTop = logBox.scrollHeight;
    };

    // 간단 CSV 파서(콤마 구분, 따옴표/이스케이프 미지원)
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h=>h.trim());
      const rows = [];
      for(let i=1;i<lines.length;i++){
        if(!lines[i].trim()) continue;
        const cols = lines[i].split(',').map(c=>c.trim());
        const obj = {};
        headers.forEach((h,idx)=>{ obj[h] = cols[idx] ?? null; });
        rows.push(obj);
      }
      return { headers, rows };
    }

    // 업로드(배치 upsert)
    document.getElementById('btnUpload').addEventListener('click', async ()=>{
      const file = document.getElementById('csvFile').files[0];
      if(!file){ alert('CSV 파일을 선택하세요'); return; }
      const text = await file.text();
      const { headers, rows } = parseCSV(text);

      if(!headers.includes('date_no') || !headers.includes('customer_name') || !headers.includes('model')){
        alert('필수 헤더(date_no, customer_name, model)가 없습니다.');
        return;
      }

      // 숫자 컬럼 가볍게 캐스팅
      rows.forEach(r=>{
        if(r.cost!==undefined && r.cost!==null && r.cost!==''){
          const n = Number(String(r.cost).replace(/[^\d.-]/g,''));
          r.cost = isNaN(n)? null : n;
        }
      });

      log(`총 ${rows.length}건 업로드 시작…`);
      const chunkSize = 200;
      for(let i=0;i<rows.length;i+=chunkSize){
        const chunk = rows.slice(i,i+chunkSize);
        const { error } = await supabase.from('as_records')
          .upsert(chunk, { onConflict: ['date_no','customer_name','model'] });
        if(error){ log(`에러: ${error.message}`, 'err'); break; }
        log(`처리: ${Math.min(i+chunk.length, rows.length)} / ${rows.length}`, 'ok');
      }
      log('완료!');
    });

    // 단건 Upsert
    document.getElementById('btnInsertOne').addEventListener('click', async ()=>{
      const row = {
        date_no: document.getElementById('f_date_no').value || null,
        customer_name: document.getElementById('f_customer_name').value || null,
        model: document.getElementById('f_model').value || null,
        status: document.getElementById('f_status').value || null,
        cost: Number(document.getElementById('f_cost').value || 0),
        branch: document.getElementById('f_branch').value || null,
      };
      if(!row.date_no || !row.customer_name || !row.model){
        alert('date_no / customer_name / model 은 필수입니다.');
        return;
      }
      const { error } = await supabase.from('as_records')
        .upsert([row], { onConflict: ['date_no','customer_name','model'] });
      if(error){ log(`에러: ${error.message}`, 'err'); }
      else{ log(`단건 Upsert 성공: ${row.date_no}`, 'ok'); }
    });
  </script>
</body>
</html>
