<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AS 대시보드 · Pretty</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>.card-shadow{box-shadow:0 10px 25px -10px rgba(0,0,0,.15);}</style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-indigo-600 text-white grid place-content-center font-bold">AL</div>
        <h1 class="text-lg font-semibold">Aqara Life · AS Dashboard</h1>
      </div>
      <nav class="flex items-center gap-3">
        <a href="upload_pretty.html" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">업로드</a>
        <a href="dashboard_pretty.html" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">대시보드</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-6 pb-16">
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-2xl p-5 border border-slate-200 card-shadow">
        <div class="text-sm text-slate-500">총 건수</div>
        <div id="kpi_total" class="mt-2 text-3xl font-bold tracking-tight">-</div>
      </div>
      <div class="bg-white rounded-2xl p-5 border border-slate-200 card-shadow">
        <div class="text-sm text-slate-500">완료</div>
        <div id="kpi_done" class="mt-2 text-3xl font-bold text-emerald-600">-</div>
      </div>
      <div class="bg-white rounded-2xl p-5 border border-slate-200 card-shadow">
        <div class="text-sm text-slate-500">진행중</div>
        <div id="kpi_pending" class="mt-2 text-3xl font-bold text-amber-600">-</div>
      </div>
      <div class="bg-white rounded-2xl p-5 border border-slate-200 card-shadow">
        <div class="text-sm text-slate-500">총 비용</div>
        <div id="kpi_cost" class="mt-2 text-3xl font-bold">-</div>
      </div>
    </section>

    <section class="mt-6 bg-white rounded-2xl border border-slate-200 card-shadow">
      <div class="p-4 flex flex-col lg:flex-row gap-3 lg:items-center lg:justify-between">
        <div class="flex gap-3">
          <input id="q_model" class="px-3 py-2 rounded-xl border border-slate-300 w-56" placeholder="model 검색">
          <select id="q_status" class="px-3 py-2 rounded-xl border border-slate-300">
            <option value="">status 전체</option>
            <option value="complete">complete</option>
            <option value="pending">pending</option>
          </select>
          <button id="btn_refresh" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-700">새로고침</button>
        </div>
        <div class="text-sm text-slate-500">최근 100건 표시</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-600">
            <tr>
              <th class="text-left px-4 py-3">date_no</th>
              <th class="text-left px-4 py-3">customer</th>
              <th class="text-left px-4 py-3">model</th>
              <th class="text-left px-4 py-3">status</th>
              <th class="text-left px-4 py-3">cost</th>
              <th class="text-left px-4 py-3">branch</th>
              <th class="text-left px-4 py-3">created_at</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
    <div class="bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg text-sm">업데이트됨</div>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    function showToast(msg){
      const el = document.getElementById('toast');
      el.firstElementChild.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'), 1600);
    }

    async function loadKPIs(){
      let { data, error } = await supabase.from('as_statistics').select('*').maybeSingle();
      if(!error && data){
        document.getElementById('kpi_total').textContent = (data.total_count ?? 0).toLocaleString();
        document.getElementById('kpi_done').textContent = (data.complete_count ?? 0).toLocaleString();
        document.getElementById('kpi_pending').textContent = (data.pending_count ?? 0).toLocaleString();
        document.getElementById('kpi_cost').textContent = ((data.total_cost ?? 0)).toLocaleString() + ' 원';
        return;
      }
      const res = await supabase.from('as_records').select('status,cost').limit(10000);
      if(res.error) return;
      const rows = res.data || [];
      const total = rows.length;
      const done = rows.filter(r=>r.status==='complete').length;
      const pend = rows.filter(r=>r.status!=='complete').length;
      const cost = rows.reduce((a,b)=>a+(Number(b.cost)||0),0);
      document.getElementById('kpi_total').textContent = total.toLocaleString();
      document.getElementById('kpi_done').textContent = done.toLocaleString();
      document.getElementById('kpi_pending').textContent = pend.toLocaleString();
      document.getElementById('kpi_cost').textContent = cost.toLocaleString() + ' 원';
    }

    function badge(status){
      if(status==='complete') return '<span class="px-2 py-1 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-200">complete</span>';
      if(status==='pending') return '<span class="px-2 py-1 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-200">pending</span>';
      return '<span class="px-2 py-1 rounded-full text-xs bg-slate-100 text-slate-700 border border-slate-200">'+(status||'-')+'</span>';
    }

    async function loadTable(){
      const model = document.getElementById('q_model').value.trim();
      const status = document.getElementById('q_status').value;

      let query = supabase.from('as_records').select('date_no,customer_name,model,status,cost,branch,created_at').order('created_at', { ascending:false }).limit(100);
      if(model) query = query.ilike('model', `%${model}%`);
      if(status) query = query.eq('status', status);
      const { data, error } = await query;

      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      if(error){
        tb.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-rose-700">에러: '+error.message+'</td></tr>';
        return;
      }
      (data||[]).forEach(r=>{
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50';
        tr.innerHTML = `
          <td class="px-4 py-3 font-medium">${r.date_no ?? ''}</td>
          <td class="px-4 py-3">${r.customer_name ?? ''}</td>
          <td class="px-4 py-3">${r.model ?? ''}</td>
          <td class="px-4 py-3">${badge(r.status)}</td>
          <td class="px-4 py-3">${(Number(r.cost)||0).toLocaleString()}</td>
          <td class="px-4 py-3">${r.branch ?? ''}</td>
          <td class="px-4 py-3 text-slate-500">${r.created_at ?? ''}</td>
        `;
        tb.appendChild(tr);
      });
    }

    document.getElementById('btn_refresh').addEventListener('click', async ()=>{
      await loadKPIs();
      await loadTable();
      showToast('새로고침 완료');
    });

    (async ()=>{
      await loadKPIs();
      await loadTable();
    })();
  </script>
</body>
</html>
